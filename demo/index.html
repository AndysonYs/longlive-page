<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LongLive Interactive Video Generation Demo</title>
    <style>
      :root {
        --page-max-width: 1440px;
        --gap: 20px;
        --radius: 12px;
        --border: 1px solid #e5e7eb;
        --bg-panel: #ffffff;
        --bg-page: #f8fafc;
        --text: #0f172a;
        --muted: #64748b;
        --primary: #2563eb;
        --primary-contrast: #ffffff;
      }

      /* --- Base --- */
      html, body { height: 100%; }
      *, *::before, *::after { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: Calibri, "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background: var(--bg-page);
        background-image:
          radial-gradient(1200px 600px at 80% -10%, #eef2ff 0%, rgba(238, 242, 255, 0) 60%),
          linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
      }

      .page {
        max-width: var(--page-max-width);
        margin: 0 auto;
        padding: 28px 20px 40px;
        display: grid;
        gap: calc(var(--gap) * 1.25);
      }

      /* --- Panels --- */
      .panel {
        background: var(--bg-panel);
        border: var(--border);
        border-radius: var(--radius);
        padding: 22px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      }

      .label {
        display: block;
        margin-bottom: 10px;
        color: var(--muted);
        font-size: 15px;
        font-weight: 600;
      }

      /* --- Top row grid (Submitted Prompts | Video) + bottom row form in same grid --- */
      .text-grid {
        display: grid;
        grid-template-columns: 3fr 7fr; /* 左: Submitted | 右: Video */
        grid-template-rows: auto auto;   /* 顶部一行，底部表单一行 */
        gap: var(--gap);
        align-items: stretch;
      }

      /* Place items in grid */
      .panel-submitted { grid-column: 1; grid-row: 1; display: flex; flex-direction: column; }
      .grid-video      { grid-column: 2; grid-row: 1; }
      .panel-form      { grid-column: 1 / -1; grid-row: 2; }

      /* Make left panel fill height */
      .panel-submitted .log-list { flex: 1 1 auto; min-height: 0; }

      /* --- Video box --- */
      .video-box { overflow: hidden; width: 100%; }
      .video-title {
        font-size: 22px; font-weight: 700; color: #0f172a; margin: 0 0 12px; letter-spacing: 0.2px; text-align: center;
      }

      .video-wrap { position: relative; }

      .video-overlay {
        position: absolute; inset: 0; display: grid; place-items: center; background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(1px); transition: opacity 180ms ease;
      }
      .video-overlay.hidden { opacity: 0; pointer-events: none; }
      .spinner { width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.35); border-top-color: #fff; border-radius: 50%; animation: spin 0.9s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }

      .video-box video {
        width: 100%;
        aspect-ratio: 21 / 9;
        background: #000;
        border-radius: 12px;
        display: block;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
      }

      .video-timer {
        margin-top: 8px;
        font-size: 18px;
        color: var(--muted);
        text-align: center;
      }

      /* --- Submitted Prompts list --- */
      .log-list {
        width: 100%;
        min-height: 260px;
        box-sizing: border-box;
        padding: 12px;
        border-radius: 10px;
        border: var(--border);
        background: #fff;
        overflow-y: auto;
        display: grid;
        gap: 10px;
      }
      .log-item {
        padding: 10px 12px;
        border-radius: 10px;
        border: var(--border);
        background: #fff;
        line-height: 1.5;
        color: var(--text);
        font-size: 13px;
      }

      /* --- Form (bottom row) --- */
      form#textForm {
        display: grid;
        grid-template-columns: 3fr 7fr; /* 与上方两列对齐 */
        grid-auto-rows: auto;
        gap: 12px;
        align-items: center;
      }

      #textInput {
        grid-column: 1 / -1; /* 跨两列，与上方网格对齐 */
        width: 100%;
        min-height: 64px;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 10px;
        border: var(--border);
        outline: none;
        background: #fff;
        transition: box-shadow 120ms ease, border-color 120ms ease;
        resize: vertical;
      }
      #textInput::placeholder { color: #94a3b8; }
      #textInput:focus { border-color: #60a5fa; box-shadow: 0 0 0 4px rgba(37,99,235,0.15); }

      /* 提交按钮放在右列并右对齐 */
      form#textForm button[type="submit"] { grid-column: 2; justify-self: end; }

      button[type="submit"] {
        height: 48px; padding: 0 18px; font-size: 16px; border: none; border-radius: 10px;
        background: #85B737; color: var(--primary-contrast);
        cursor: pointer; box-shadow: 0 6px 16px rgba(133, 183, 55, 0.25);
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }
      button[type="submit"]:hover { filter: brightness(1.03); box-shadow: 0 10px 22px rgba(133,183,55,0.35); }
      button[type="submit"]:active { transform: translateY(1px); filter: brightness(0.98); box-shadow: 0 6px 16px rgba(133,183,55,0.25); }
      button[type="submit"]:focus-visible { outline: none; box-shadow: 0 0 0 4px rgba(133,183,55,0.3), 0 6px 16px rgba(133,183,55,0.25); }

      /* --- Responsive --- */
      @media (max-width: 900px) {
        .text-grid { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
        .panel-submitted { grid-column: 1; grid-row: 1; }
        .grid-video      { grid-column: 1; grid-row: 2; }
        .panel-form      { grid-column: 1; grid-row: 3; }
        form#textForm { grid-template-columns: 1fr; }
        form#textForm button[type="submit"] { grid-column: 1; justify-self: stretch; }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <section>
        <!-- 上方视频已移入下方网格布局中 -->
      </section>

      <section>
        <div class="text-grid">
          <!-- 左侧：Submitted Prompts（3） -->
          <div class="panel panel-submitted">
            <label id="submittedLabel" class="label">Submitted Prompts</label>
            <div id="textLogList" class="log-list" aria-live="polite"></div>
          </div>

          <!-- 右侧：Video（7） -->
          <div class="panel video-box grid-video">
            <div class="video-wrap">
              <video id="videoLeft" muted playsinline preload="none" data-src="../assets/longlive-ironman.mp4"></video>
              <div id="overlayLeft" class="video-overlay hidden">
                <div class="spinner"></div>
              </div>
            </div>
            <div id="videoTimer" class="video-timer" aria-live="polite">0.0s</div>
          </div>

          <!-- 下方：Input 表单（占满第二行） -->
          <div class="panel panel-form">
            <form id="textForm" autocomplete="off">
              <label id="textInputLabel" class="label">Input Text</label>
              <textarea id="textInput" rows="2" placeholder="Type here…"></textarea>
              <button type="submit">Submit</button>
            </form>
          </div>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById('textForm');
      const input = document.getElementById('textInput');
      const logList = document.getElementById('textLogList');
      const videoLeft = document.getElementById('videoLeft');
      const overlayLeft = document.getElementById('overlayLeft');
      const timerEl = document.getElementById('videoTimer');

      function updateTimer() {
        if (!timerEl) return;
        const t = Number(videoLeft?.currentTime || 0);
        timerEl.textContent = (Number.isFinite(t) ? t : 0).toFixed(1) + 's';
      }

      function setVideoBlack(video) {
        try { video.removeAttribute('src'); video.load(); } catch (_) {}
      }
      setVideoBlack(videoLeft);
      updateTimer();

      let logItemCount = 0;

      function appendLineToLog(line) {
        const trimmed = String(line).trim();
        if (!trimmed) return;
        const palette = [
          { border: '#2563eb', bg: 'rgba(37,99,235,0.08)' },
          { border: '#059669', bg: 'rgba(5,150,105,0.10)' },
          { border: '#9333ea', bg: 'rgba(147,51,234,0.10)' },
          { border: '#dc2626', bg: 'rgba(220,38,38,0.08)' },
          { border: '#0ea5e9', bg: 'rgba(14,165,233,0.10)' },
          { border: '#f59e0b', bg: 'rgba(245,158,11,0.12)' }
        ];
        const idx = logItemCount % palette.length;
        const { border, bg } = palette[idx];
        const item = document.createElement('div');
        item.className = 'log-item';
        item.textContent = trimmed;
        item.style.background = bg;
        item.style.borderLeft = '4px solid ' + border;
        logList.appendChild(item);
        logList.scrollTop = logList.scrollHeight;

        logItemCount += 1;

        // 仅保留最近 3 条
        while (logList.children.length > 3) {
          logList.removeChild(logList.firstChild);
        }
      }

      let firstSubmitDone = false;
      const delay = (ms) => new Promise(r => setTimeout(r, ms));

      // 防止递归触发与堆积：
      let isSimulatedSubmit = false;
      let simSeriesScheduled = false;
      let pendingSimTimers = [];

      function clearSimTimers() {
        if (pendingSimTimers && pendingSimTimers.length) {
          for (const t of pendingSimTimers) { try { clearTimeout(t); } catch (_) {} }
        }
        pendingSimTimers = [];
      }

      // 需要你填写的文本（按顺序依次打字并提交）
      const simTexts = [
        'He stops and stands still.',
        'A hail of bullets tears in.',
        'He raises his arm, rounds and shells streak past.',
        'Emerald-green beams sweep down the street.',
        'He aims and fires tight, pulsed red repulsor blasts from his palm.',
        'The chest arc reactor unleashes a colossal blue beam',
        'A dark alien craft enters from the left and cruises across',
        'He looks up, trying to find the alien craft.'
      ];

      // 每次提交之间的间隔（毫秒）列表
      const simDelays = [
        6000, 3000, 5500, 4000, 10500, 11500, 9500, 8500
      ];

      function simulateTypingAndSubmit(text, perCharMs = 40) {
        if (!text) return;
        input.focus();
        input.value = '';
        let i = 0;
        const intervalId = setInterval(() => {
          input.value += text[i++];
          if (i >= text.length) {
            clearInterval(intervalId);
            isSimulatedSubmit = true;
            try { form.requestSubmit(); } finally { isSimulatedSubmit = false; }
          }
        }, perCharMs);
      }

      async function runStagedPlaybackSingle() {
        overlayLeft.classList.remove('hidden');
        await delay(2000);
        if (!videoLeft.src) {
          const src = videoLeft.dataset.src;
          videoLeft.src = src;
          try { await videoLeft.play(); } catch (_) {}
          videoLeft.pause();
          try { videoLeft.currentTime = 0; } catch (_) {}
          updateTimer();
        }
        overlayLeft.classList.add('hidden');
        await delay(1000);
        try { await videoLeft.play(); } catch (_) {}
      }

      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        appendLineToLog(input.value);
        input.value = '';
        input.focus();
        if (!firstSubmitDone) { firstSubmitDone = true; runStagedPlaybackSingle(); }

        // 仅对第一次“用户手动提交”安排一系列模拟提交
        if (!isSimulatedSubmit && !simSeriesScheduled) {
          simSeriesScheduled = true;
          clearSimTimers();
          const total = simTexts.length;
          const defaultFirstDelay = 6000;
          const defaultInterval = 5000;
          let elapsed = 0;
          for (let i = 0; i < total; i++) {
            const text = simTexts[i];
            const d = Number(simDelays[i]);
            const delta = Number.isFinite(d) ? d : (i === 0 ? defaultFirstDelay : defaultInterval);
            elapsed += delta;
            const timerId = setTimeout(() => { simulateTypingAndSubmit(text); }, elapsed);
            pendingSimTimers.push(timerId);
          }
        }
      });

      // 计时器事件绑定：以 0.1s 精度显示当前时间
      ['timeupdate','seeked','seeking','play','pause','loadedmetadata','loadeddata','ratechange','stalled','waiting']
        .forEach(evt => videoLeft.addEventListener(evt, updateTimer));
      // 当播放结束时也更新一次，确保显示最终时间
      videoLeft.addEventListener('ended', updateTimer);
    </script>
  </body>
</html>
